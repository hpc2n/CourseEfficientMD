"""
Generated by CHARMM-GUI (http://www.charmm-gui.org)

step3_charmm2gmx_rest.py

This program is for generating GROMACS restraints file.

Correspondance: jul316@lehigh.edu or wonpil@lehigh.edu
Last update: August 20, 2015
"""

import sys, os

infile  = sys.argv[1]

funcForPosres = 1
funcForDihres = 1

posres = []
dihres = []

prot = False
carb = False

for line in open(infile.lower(), 'r'):
	line = line.strip()
	if len(line) > 0:
		segments = line.split()
		moltype = segments[0]
		restype = segments[1]
		if moltype == 'PROT' and restype == 'POS':
			atom1 = int(segments[2])
			stat1 = segments[3]
			posres.append([moltype, atom1, stat1])
			prot  = True
		if moltype == 'CARB' and restype == 'DIH':
			atom1 = int(segments[2])
			atom2 = int(segments[3])
			atom3 = int(segments[4])
			atom4 = int(segments[5])
			phi0  = float(segments[6])
			dphi  = float(segments[7])
			dihres.append([moltype, atom1, atom2, atom3, atom4, phi0, dphi])
			carb  = True

posres.sort()
dihres.sort()

if len(posres) == 0 and len(dihres) == 0: exit()

if not os.path.exists('gromacs/restraints'):
    os.mkdir('gromacs/restraints')
outfile = open('gromacs/restraints/'+infile.upper().split('_')[1]+'_rest.itp', 'w')

fc_quick = {}

fc_quick['bb']   = [ 400.0,  400.0]
fc_quick['sc']   = [  40.0,   40.0]
fc_quick['carb'] = [   4.0,    4.0]

for step in range(2):
	outfile.write('#ifdef STEP4_%d\n' % step)
	if prot:
		outfile.write('#define fc_bb %.1f\n' % fc_quick['bb'][step])
		outfile.write('#define fc_sc %.1f\n' % fc_quick['sc'][step])
	if carb: outfile.write('#define fc_cdih %.1f\n' % fc_quick['carb'][step])
	outfile.write('#endif\n')

if len(posres) > 0:
	outfile.write('\n[ position_restraints ]\n')
	for iposres in posres:
		moltype = iposres[0]
		atom1 = iposres[1]
		if moltype == 'PROT':
			stat1 = iposres[2]
			if stat1 == 'BB': fc = 'fc_bb'
			if stat1 == 'SC': fc = 'fc_sc'
			outfile.write('%5d %5d %8s %8s %8s\n' % (atom1, funcForPosres, fc, fc, fc))

if len(dihres) > 0:
	outfile.write('\n[ dihedral_restraints ]\n')
	for idihres in dihres:
		moltype = idihres[0]
		atom1   = idihres[1]
		atom2   = idihres[2]
		atom3   = idihres[3]
		atom4   = idihres[4]
		phi0    = idihres[5]
		dphi    = idihres[6]
		if moltype == 'CARB': fc = 'fc_cdih'
		outfile.write('%5d %5d %5d %5d %5d %8.1f %8.1f %8s\n' % (atom1, atom2, atom3, atom4, funcForDihres, phi0, dphi, fc))

